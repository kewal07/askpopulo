{% extends "polls/common.html" %}
{% load static %}
{% block extra_css %}
	<link rel="stylesheet" type="text/css" href="{% static 'polls/css/index.css' %}" />
{% endblock %}
{% block content %}
	<section id="content">
			{% if data.data %}
					{% for question in data.data %}
					<div class="questions">
						<div class="questionContent">
							<div class="userInfo">
								<div class="userImage">
									{% if question.question.user.extendeduser %}
										{% if question.question.isAnonymous %}
											<img src="/static/login/images/defaultAvatar.png"  alt="Anonymous">
										{% else %}
											<img src="{{ question.question.user.extendeduser.get_profile_pic_url }}"  alt="User {{ question.question.user.first_name }}">
										{% endif %}
									{% else %}
										<img src="/static/login/images/defaultAvatar.png"  alt="User {{ question.question.user.first_name }}">
									{% endif %}
								</div>
								<div class="userBrief">
									<p>
										{% if question.question.isAnonymous %}
											Anonymous
										{% else %}
											{{question.question.user.first_name}}
										{% endif %}
									</p>
									<p>
										Asked on:<br>
										{{ question.question.pub_date }}
									</p>
								</div>
							</div> 
							<div class="mainPoll">
								<p>
								<a href="{% url 'polls:polls_vote' question.question.id question.question.que_slug %}">{{question.question.question_text}}</a>
								{% if user.is_authenticated %}
								{% if user == question.question.user %}
								<a href="{% url 'polls:polls_edit' question.question.id question.question.que_slug %}"><i class="fa fa-pencil-square-o"></i></a>
								<a href="{% url 'polls:polls_delete' question.question.id question.question.que_slug %}"><i class="fa fa-trash-o"></i></a>
								{% endif %}
								{% endif %}
								</p>
								<form class="optionsForm" action="{% url 'polls:polls_vote' question.question.id question.question.que_slug %}" method="POST" id="optionsForm{{ question.question.id }}">
									{% csrf_token %}
									<input type="hidden" name="question" value="{{ question.question.id }}" />
									{% for choice in question.question.choice_set.all %}
										<p>
											<input class="choices" type="radio" name="choice" id="choice{{ choice.id }}" value="{{ choice.id }}" />
											<label for="choice{{ choice.id }}">
												{% if choice.choice_image %}
												<script>
													$("#choice{{ choice.id }}").hide();
													var item = $("#choice{{ choice.id}}");
													item.parent().css({"display":"inline-block"});
													// console.log($this.parent().next().children().first().show());
												</script>
													<img class="choices choice_image" id="choice{{ choice.id }}" src="/media/choices/{{ choice.get_file_name }}" alt="{{ choice.choice_text }}">
													<!-- <p>{{ choice.choice_text }}</p> -->
												{% else %}
													{{ choice.choice_text }}
												{% endif %}
											</label>
										</p>
									{% endfor %}
									<input class="submit" type="submit" value="Vote" id="{{ question.question.id }}---{{ question.question.que_slug }}"/>
								</form>
								<!-- {{ question.question.questionwithcategory_set.all }} -->
								<div class="pollInfo clearfix">
									<ul class="pollInfoUl clearfix">
										<li><span class="pollInfoNum">{{question.votes}}</span> opinion{{question.votes|pluralize}}</li>
										<li><span class="pollInfoNum" id="sub_num{{ question.question.id }}">{{question.subscribers}}</span> interested</li>
										<li>{% if question.question.id in data.subscribed %}
												<button class="btn followButton following" id="follow{{ question.question.id }}---{{ question.question.que_slug }}">Following</button>
											{% else %}
												<button class="btn followButton" id="follow{{ question.question.id }}---{{ question.question.que_slug }}" >Follow</button>
											{% endif %}
										</li>
										<li ><div class="fb-share-button" data-href="http://127.0.0.1:8000/{% url 'polls:polls_vote' question.question.id question.question.que_slug %}" data-layout="button_count"></div></i></li>
										<li><i class="fa fa-twitter"></i></li>
										<li><i class="fa fa-google-plus"></i></li>
									</ul>
								</div>
							</div>
						</div>
					</div>
					{% endfor %}
			{% else %}
					<p>No polls are available</p>
			{% endif %}		
	</section>
	<script type="text/javascript">
		$(document).ready(function()
		{
			$('.submit').bind('click', function()
			{
				console.log("click called..........");
				var queid = $(this)[0].id.split("---")[0];
				var queslug = $(this)[0].id.split("---")[1];
				var elemid = "#optionsForm"+queid;//$(this)[0].id
				console.log($(elemid)); 
				//val
				$(elemid).bind('submit', function()
				{
					console.log("submit called....");
					$.ajax(
					{
						type: 'POST',
						url:'polls/'+queid+"/"+queslug,
						data:$(elemid).serialize(),
						success:function(response)
						{
							var form_errors = response.form_errors;
							console.log(response.form_errors);
							console.log(typeof form_errors === 'undefined');

							if(typeof form_errors === 'undefined'){
								 $(elemid).unbind('submit').submit();
							}else{
								openOverlay("#overlay-inAbox");
							}
						}
					});     
					return false;
				});
			});
			$('.followButton').bind('click', function(e){
				// e.preventDefault();
				console.log($(this)[0].id)
				$button = $("#"+$(this)[0].id);
				console.log($button);
				var qid = $(this)[0].id.split("---")[0].replace("follow","");
				var qslug = $(this)[0].id.split("---")[1];
				{% if user.is_authenticated %}
					if($button.hasClass('following')){
						
						//$.ajax(); Do Unfollow
						var data = {'follow' : false, 'question' : qid, 'csrfmiddlewaretoken': "{{ csrf_token }}"}
						console.log(data);
						$.ajax(
						{
							type: 'POST',
							url:'follow/'+qid+'/'+qslug,
							data:data,
							success:function(response)
							{
								$("#sub_num"+qid).text(response.sub_count);
							}
						});  
						
						$button.removeClass('following');
						$button.removeClass('unfollow');
						$button.text('Follow');
					} else {
						
						// $.ajax(); Do Follow
						var data = {'follow' : true, 'question' : qid, 'csrfmiddlewaretoken': "{{ csrf_token }}"}
						console.log(data);
						$.ajax(
						{
							type: 'POST',
							url:'follow/'+qid+'/'+qslug,
							data:data,
							success:function(response)
							{
								$("#sub_num"+qid).text(response.sub_count);
							}
						});  
						
						$button.addClass('following');
						$button.text('Following');
					}
				{% else %}
					url = 'polls/'+qid+'/'+qslug
					console.log(url);
					$(location).attr('href',url);
				{% endif %}
				return false;
			});

			$('.followButton').hover(function(){
				$button = $("#"+$(this)[0].id);
				if($button.hasClass('following')){
					$button.addClass('unfollow');
					$button.text('Unfollow');
				}
			}, function(){
				if($button.hasClass('following')){
					$button.removeClass('unfollow');
					$button.text('Following');
				}
			});
		});
	</script>
{% endblock %}