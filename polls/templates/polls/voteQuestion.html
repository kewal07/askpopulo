{% extends "polls/common.html" %}
{% load static %}
{% block meta_data_extra %}
	{% with question.has_image as has_image %}
	{%if has_image|length > 0 %}
	{% for share_image in has_image %}
		<meta property="og:image" content="http://{{ request.META.HTTP_HOST }}{{ share_image }}"/>
	{% endfor %}
		<meta property="og:image:width" content="300" /> 
		<meta property="og:image:height" content="300" />
	{% else %}
		<meta property="og:image" content="http://{{ request.META.HTTP_HOST }}/static/pollsLogoShareNew.png"/>
	{% endif %}
	{% endwith %}
	<meta property="fb:page_id" content="question.id" />
	<meta property="og:url" content="https://{{ request.META.HTTP_HOST }}{{ request.path }}"/>
	<meta property="og:title" content="{{ question.question_text  }}"/>
	<meta property="og:description" content="{{ question.description  }}" />
{% endblock %}
{% block extra_css %}
	<link rel="stylesheet" type="text/css" href="{% static 'polls/css/index.css' %}" />
{% endblock %}
{% block content %}
	<section id="content">
		<div class="questions">
			<div class="questionContent">
				<div class="userInfo">
					<div class="userImage">
						<a href="{{ question.get_user_details.user_url }}">
							<img src="{{ question.get_user_details.pic_url }}"  alt="{{ question.get_user_details.user_alt }}">
						</a>
					</div>
					<div class="userBrief">
						<p>
							<a href="{{ question.get_user_details.user_url }}">
								{{ question.get_user_details.user_name }}
							</a>
						</p>
						<p>
							Asked on:<br>
								<span id="{{ question.id }}pubdate"></span><br>
						</p>
					</div>
				</div> 
				<div class="mainPoll">
					<p class="que_text">{{ question.question_text }}
					{% if user.is_authenticated %}
					{% if user == question.user or user.is_superuser %}
					{% if question.voted_set.count < 1 or user.is_superuser %}
					<a href="{% url 'polls:polls_edit' question.id question.que_slug %}"><i class="fa fa-pencil-square-o"></i></a>
					{% endif %}
					<a href="{% url 'polls:polls_delete' question.id question.que_slug %}"><i class="fa fa-trash-o"></i></a>
					{% endif %}
					{% endif %}
					</p>
					{% if question.description or question.questionwithcategory_set.count > 0 %}
					<p class="question_description_header">
							<span class="question_description_header_span">Description</span>
					</p>
					<p class="question_description">
						{{ question.description }}
						{% if question.description and question.questionwithcategory_set.count > 0 %}<br><br>{% endif %}
						{% for cat in question.questionwithcategory_set.all %}
							<a class="que_desc_cat_span" href="{% url 'polls:polls_category' %}?category={{ cat.category.category_title }}">{{ cat.category.category_title }}</a>
						{% endfor %}
					</p>
					{% endif %}
					<div class="upvoteDetailVote">
						<i class="fa fa-thumbs-up fa-2x upvoted" onclick="upvoted({{ question.id }},'{{ question.que_slug }}',1)"></i>
						<span id="upvoteon{{ question.id }}"> {{ question.upvoteCount }} </span>
						<i class="fa fa-thumbs-down fa-2x upvoted fa-flip-horizontal fa-rotate-180" onclick="upvoted({{ question.id }},'{{ question.que_slug }}',0)"></i>
						<div class="upvotemessage" id="upvotemessage{{ question.id }}"></div>
					</div>
					<p>
					<form class="optionsForm" action="{% url 'polls:polls_vote' question.id question.que_slug %}" method="POST" id="optionsForm{{ question.id }}">
						{% csrf_token %}
						<input type="hidden" name="question" value="{{ question.id }}" />
						<input type="hidden" name="betAmountHidden" id="betAmountHidden" value="" />
						{% for choice in question.choice_set.all %}
							<p>
								<input class="choices" type="radio" name="choice" id="choice{{ choice.id }}" value="{{ choice.id }}" />
								<label for="choice{{ choice.id }}">
									{% if choice.choice_image %}
									<script>
										$('.choice_image').css({"width":"120px","height":"120px"});
										$("#choice{{ choice.id }}").hide();
										var item = $("#choice{{ choice.id}}");
										item.parent().css({"display":"inline-block"});
										// console.log($this.parent().next().children().first().show());
									</script>
										<img class="choices choice_image" id="choice{{ choice.id }}" src="/media/choices/{{ choice.get_file_name }}" title="{{ choice.choice_text }}" alt="{{ choice.choice_text }}">
										<!-- {{ choice.choice_text }} -->
									{% else %}
										{{ choice.choice_text }}
									{% endif %}
								</label>
							</p>
						{% endfor %}
						<p>
						{% if question.user_already_voted %}
							<a class="submit anchor_submit" id="voteResultButtonLink{{ question.id }}" href="{% url 'polls:polls_vote' question.id question.que_slug %}">Results</a>
						{% else %}
							{% if expired %}
								<input class="submit voteSubmit" type="submit" value="Timed Out" id="{{ question.id }}---{{ question.que_slug }}" disabled="disabled"/>
							{% else %}
								<input class="submit voteSubmit" type="submit" value={% if question.isBet %}"Predict"{% else %}"Vote"{% endif %} id="vote{{ question.id }}---{{ question.que_slug }}---{{ question.isBet }}"/>
							{% endif %}
							{% if user.is_authenticated and user.id == question.user.id or expired %}
								{% if user.is_authenticated %}
									<a class="submit anchor_submit voteResultSubmit" id="voteResultButtonLink{{ question.id }}" href="{% url 'polls:polls_vote' question.id question.que_slug %}">Results</a>
								{% else %}
									<a class="submit anchor_submit voteResultSubmit" id="voteResultButtonLink{{ question.id }}" href="{% url 'account_login' %}?next={% url 'polls:polls_vote' question.id question.que_slug %}">Results</a>
								{% endif %}
							{% endif %}
						{% endif %}
					</p>
					</form>
				</div>
			</div>
			<div class="pollInfo  pollsInfoVotePage clearfix">
				<div class="pollInfoDataDetail clearfix">
					<ul class="pollInfoUl clearfix">
						<li><span class="pollInfoNum">{{ votes }}</span> <i title="opinions" class="fa fa-check-circle"></i></li>
						<li><span class="pollInfoNum" id="sub_num{{ question.id }}">{{ question.subscriber_set.count }}</span> <i title="interested" class="fa fa-users"></i></li>
						<li>{% if question.id in subscribed %}
								<button class="btn followButton following" id="follow{{ question.id }}---{{ question.que_slug }}">Following</button>
							{% else %}
								<button class="btn followButton" id="follow{{ question.id }}---{{ question.que_slug }}" >Follow</button>
							{% endif %}
						</li>
						<li><i id="ban{{ question.id }}" title="Report Spam" class="fa fa-ban" style="color:red; cursor:pointer"></i></li>
						<li>
							{% if question.expiry and not expired %}
								<!-- Time Left:<br> -->
								<div id="{{ question.id }}timer" class="timerClass"></div>
							{% endif %}
							<script>
								var currentDate = new Date();
								var offset = currentDate.getTimezoneOffset();
								
								var utcDate = new Date({{ question.pub_date.year }}, {{ question.pub_date.month }} - 1, {{ question.pub_date.day }}, {{ question.pub_date.hour }}, {{ question.pub_date.minute }}, {{ question.pub_date.second }});

								var publicationDate = new Date({{ question.pub_date.year }}, {{ question.pub_date.month }}, {{ question.pub_date.day }}, {{ question.pub_date.hour }}, {{ question.pub_date.minute }}-offset, {{ question.pub_date.second }});
								var pubDateString = publicationDate.getFullYear()+'/'+publicationDate.getMonth()+'/'+publicationDate.getDate()+' '+publicationDate.getHours()+':'+publicationDate.getMinutes();
								document.getElementById('{{ question.id }}pubdate').innerHTML = pubDateString;

								{% if question.expiry and not question.expired %}
								var expiryDate = new Date({{ question.expiry.year }}, {{ question.expiry.month }}, {{ question.expiry.day }}, {{ question.expiry.hour }}, {{ question.expiry.minute }}-offset, {{ question.expiry.second }});
								$("#{{ question.id }}timer").countdown({until: new Date({{ question.expiry.year }}, {{ question.expiry.month }} - 1, {{ question.expiry.day }}, {{ question.expiry.hour }}, {{ question.expiry.minute }}-offset, {{ question.expiry.second }}),compact: true, onExpiry:disableVoteButton});
								{% endif %}

								function disableVoteButton(){
									$('#vote{{ question.id }}---{{ question.que_slug }}').attr('disabled','disabled');
									$('#vote{{ question.id }}---{{ question.que_slug }}').attr('id','{{ question.id }}---{{ question.que_slug }}');
									$('#vote{{ question.id }}---{{ question.que_slug }}').removeAttr('vote{{ question.id }}---{{ question.que_slug }}');
									$('#{{ question.id }}---{{ question.que_slug }}').attr('value','Expired');
								}
							</script>
						</li>
						<ul class="pollInfoUl clearfix share-buttons">
							<li ><div class="fb-share-button" data-href="http://{{ request.META.HTTP_HOST  }}/{% url 'polls:polls_vote' question.id question.que_slug %}" data-layout="button_count"></div></li>&nbsp&nbsp&nbsp
							<li><a href="https://twitter.com/share" class="twitter-share-button" data-url="https://{{ request.META.HTTP_HOST }}{% url 'polls:polls_vote' question.id question.que_slug %}" data-via="askbypoll" data-count="horizontal" data-counturl="https://{{ request.META.HTTP_HOST }}{% url 'polls:polls_vote' question.id question.que_slug %}" data-hashtags="AskByPoll">Tweet</a></li>&nbsp&nbsp&nbsp
							<li><div class="g-plus" data-action="share" data-annotation="bubble" data-href="http://{{ request.META.HTTP_HOST  }}/{% url 'polls:polls_vote' question.id question.que_slug %}"></div></li>
						</ul>							
					</ul>
				</div>
			</div>
			<p style="text-align:center;font-size:1rem;margin-top:1rem">
				Login/Vote to see the results
			</p>
			<div id="disqus_thread">
			</div>
		</div>
	</section>
	<script type="text/javascript">
		{% if user.is_authenticated %}
			var disqus_shortname = 'askbypoll';

			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function() {
			    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
			var disqus_config = function() {
				this.page.remote_auth_s3 = "{{ ssoData.message }} {{ ssoData.sig }} {{ ssoData.timestamp }}";
				this.page.api_key = "{{ ssoData.pub_key }}";
				this.callbacks.onNewComment = [function(comment) { 

				var data_dict = {"que_id":{{ question.id }}, "que_author":"{{ question.user.first_name }}","to_user_id":{{ question.user.id }},"com_author":"{{ user.username }}","que_text":"{{ question.question_text }}","que_url":"https://{{ request.META.HTTP_HOST }}{% url 'polls:polls_vote' question.id question.que_slug %}", 'csrfmiddlewaretoken': "{{ csrf_token }}" };

				$.ajax({
			            type: 'POST',
			            url:'/comment_mail',
			            data:data_dict,
			            success:function(response)
			            {
			            }
			        });
				}];
			};
		{% endif %}
		function upvoted(questionId,qslug,action){
			{% if user.is_authenticated %}
				$.ajax({
					type: 'POST',
					url:'/upvoted/?qId='+questionId+'&vote='+action.toString(),
					data:{'csrfmiddlewaretoken': "{{ csrf_token }}"},
					error:function(response){
						console.log('error occured');
					},
					success:function(response)
					{
							count = response.count;
							console.log(count);
							message = response.message;
							if(typeof count === 'undefined'){
								var id = "#upvotemessage"+questionId.toString();
								$(id).append("<p>"+message+"</p>");
								setTimeout(function(){clearUpvoteMessageDiv(id);}, 1500);
							} else {
								console.log(response);
								spanId = '#upvoteon'+questionId.toString();
								$(spanId).text(response.count.toString());
							}
					}
				});
			{% else %}
				var id = "#upvotemessage"+questionId.toString();
				$(id).append("<p> Login to upvote </p>");
				setTimeout(function(){clearUpvoteMessageDiv(id);}, 1500);
				url = '{% url 'account_login' %}?next=/polls/'+questionId+'/'+qslug
				// console.log(url);
				$(location).attr('href',url);
			{% endif %}
		}

		function clearUpvoteMessageDiv(id){
			$(id).empty();
		}
		$(document).ready(function()
		{
			$('.choice_image').css({"width":"120px","height":"120px"});
			$('.submit').bind('click', function()
			{
				var voteSubmitId = $(this)[0].id;
				var queid = $(this)[0].id.replace('vote','').split("---")[0];
				var queslug = $(this)[0].id.replace('vote','').split("---")[1];
				var quebet = $(this)[0].id.replace('vote','').split("---")[2];
				var betValue = 0;
				// console.log(quebet);
				var elemid = "#optionsForm"+queid;//$(this)[0].id
				$(elemid).bind('submit', function()
				{
					$("#"+voteSubmitId).attr("disabled","disabled");
					var vote_url = "https://{{ request.META.HTTP_HOST }}"+'/polls/'+queid+'/'+queslug;
					$.ajax(
					{
						type: 'POST',
						url:'/polls/'+queid+'/'+queslug,
						data:$(elemid).serialize(),
						success:function(response)
						{
							var form_errors = response.form_errors;
							
							if(typeof form_errors === 'undefined'){
								{% if user.extendeduser.credits > 10 %}
									if(quebet === "True"){
										openOverlay("#overlay-inAbox5");
										$("#betAmount")[0].value = "";
										/* close overlay call */
										$("#cancel4").click(function(){
											closeOverlay();
											$("#"+voteSubmitId).removeAttr("disabled");
										});
										$("#okay4").click(function(){
											betValue = $("#betAmount")[0].value;
											console.log(betValue);
											if(betValue === "" || (betValue > 9 && betValue <= {{ user.extendeduser.credits }})){
												$("#betAmountHidden")[0].value = betValue;
												closeOverlay();
												$("#"+voteSubmitId).removeAttr("disabled");
												$(elemid).unbind('submit').submit();
											}
										});
										/* close overlay call end */
									}
									else{
										$("#"+voteSubmitId).removeAttr("disabled");
										$(elemid).unbind('submit').submit();
									}
								{% else %}
								 	$(elemid).unbind('submit').submit();
								{% endif %}
							}else{
								openOverlay("#overlay-inAbox");
								$("#"+voteSubmitId).removeAttr("disabled");
							}
						}
					});
					return false;
				});
			});
			$('.fa-ban').click(function()
			{
				var queid = $(this)[0].id.replace('ban','');
				$.ajax(
					{
						type: 'GET',
						url:'/abuse?qIdBan='+queid,
						success:function(response)
						{
								$('#overlay-inAbox').children().children().first().text("AskByPoll has been informed. We are looking into it. For any more details please write to us @ support@askbypoll.com ");
								openOverlay("#overlay-inAbox");
								$(this).css({"color":"red"});
						}
					});     
			});
			$('.followButton').bind('click', function(e){
				// e.preventDefault();
				// console.log($(this)[0].id)
				$button = $("#"+$(this)[0].id);
				// console.log($button);
				var qid = $(this)[0].id.split("---")[0].replace("follow","");
				var qslug = $(this)[0].id.split("---")[1];
				var follow_url = "https://{{ request.META.HTTP_HOST }}"+'/follow/'+qid+'/'+qslug
				{% if user.is_authenticated %}
					if($button.hasClass('following')){
						
						//$.ajax(); Do Unfollow
						var data = {'follow' : false, 'question' : qid, 'csrfmiddlewaretoken': "{{ csrf_token }}"}
						// console.log(data);
						$.ajax(
						{
							type: 'POST',
							url:'/follow/'+qid+'/'+qslug,
							data:data,
							success:function(response)
							{
								$("#sub_num"+qid).text(response.sub_count);
								// if($("#voteResultButtonLink"+qid).length == 0){
								// 	$("#voteResultButtonLinkonFollow"+qid).attr(
								// 		'style', "display : none !important"
								// 	);
								// }
							}
						});  
						
						$button.removeClass('following');
						$button.removeClass('unfollow');
						$button.text('Follow');
					} else {
						
						// $.ajax(); Do Follow
						var data = {'follow' : true, 'question' : qid, 'csrfmiddlewaretoken': "{{ csrf_token }}"}
						// console.log(data);
						$.ajax(
						{
							type: 'POST',
							url:'/follow/'+qid+'/'+qslug,
							data:data,
							success:function(response)
							{
								$("#sub_num"+qid).text(response.sub_count);
								// if($("#voteResultButtonLink"+qid).length == 0){
								// 	$("#voteResultButtonLinkonFollow"+qid).attr(
								// 		'style', "display : block"
								// 	);
								// }
							}
						});  
						
						$button.addClass('following');
						$button.text('Following');
					}
				{% else %}
					url = '{% url 'account_login' %}?next={% url 'polls:polls_vote' question.id question.que_slug %}'
					// console.log(url);
					$(location).attr('href',url);
				{% endif %}
				return false;
			});

			$('.followButton').hover(function(){
				$button = $("#"+$(this)[0].id);
				if($button.hasClass('following')){
					$button.addClass('unfollow');
					$button.text('Unfollow');
				}
			}, function(){
				if($button.hasClass('following')){
					$button.removeClass('unfollow');
					$button.text('Following');
				}
			});
		});
	</script>
{% endblock %}
